# OCR 文字定位渲染说明

本文档说明前端如何解析 DeepSeek OCR 的定位标签并在原图上绘制框选。

## 标签格式
OCR 输出可能包含如下定位标签：

```
<|ref|>sub_title<|/ref|><|det|>[[219, 123, 765, 195]]<|/det|>
识别文本...
```

- `ref` 表示标签类型（如 `sub_title`、`text`）。
- `det` 为检测框坐标，当前实现支持：
  - 4 个数：矩形框
  - 8 个及以上：多边形点集（自动取包围盒）

## 坐标解析与映射
前端会自动识别坐标空间并映射到原图像素坐标：

1. **坐标顺序推断**
   - 同时尝试两种顺序：`[x1, y1, x2, y2]` 与 `[y1, x1, y2, x2]`。
   - 选取更符合“文本行宽 > 高”的候选框。

2. **坐标空间识别**
   - `0 ~ 1`：归一化坐标
   - `0 ~ 100`：百分比坐标
   - `0 ~ 1000`：DeepSeek OCR 标准化 bins
   - 其他：视为像素坐标

3. **Letterbox 反算**
   - 若检测坐标近似方形而原图非方形，则视为模型输入时采用“长边缩放 + 短边填充”的坐标。
   - 根据推断出的方形基准尺寸（如 1000 bins 或常见输入尺寸）计算 padding 与缩放，再反算回原图坐标。

## 渲染流程
1. 解析 OCR 输出中的标签与坐标。
2. 生成右侧结果列表（文本 + 标签）。
3. 在原图上叠加框选，并支持点击联动高亮。

## 相关代码
- 入口与交互：`app.js`
- 关键函数：
  - `parseGroundingBlocks`：解析标签块
  - `normalizeBoxCoords`：统一坐标顺序与空间
  - `computeMapping` / `updateGroundingBoxes`：映射与渲染

如需强制指定坐标模式，可在前端增加显式开关，覆盖自动推断逻辑。
